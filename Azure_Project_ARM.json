{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location1": {
            "defaultValue": "eastus",
            "type": "String"
        },
        "location2": {
            "defaultValue": "eastus2",
            "type": "String"
        },
        "adminUsername": {
            "defaultValue": "azureadmin",
            "type": "String"
        },
        "adminPassword": {
            "type": "SecureString"
        },
        "adminObjectId": {
            "type": "String",
            "metadata": {
                "description": "c1eff04b-c670-4c5a-bf6e-f1d6353f8281"
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2024-07-01",
            "name": "eastus-VNet",
            "location": "[parameters('location1')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.0.0.0/16"
                    ]
                },
                "subnets": [
                    {
                        "name": "websubnet",
                        "properties": {
                            "addressPrefix": "10.0.1.0/24"
                        }
                    },
                    {
                        "name": "RDGatewaySubnet",
                        "properties": {
                            "addressPrefix": "10.0.2.0/24"
                        }
                    },
                    {
                        "name": "GatewaySubnet",
                        "properties": {
                            "addressPrefix": "10.0.255.0/27"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2024-07-01",
            "name": "eastus2-VNet",
            "location": "[parameters('location2')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.1.0.0/16"
                    ]
                },
                "subnets": [
                    {
                        "name": "appsubnet",
                        "properties": {
                            "addressPrefix": "10.1.1.0/24"
                        }
                    },
                    {
                        "name": "GatewaySubnet",
                        "properties": {
                            "addressPrefix": "10.1.255.0/27"
                        }
                    },
                    {
                        "name": "AzureFirewallSubnet",
                        "properties": {
                            "addressPrefix": "10.1.254.0/26"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "apiVersion": "2024-07-01",
            "name": "eastus-VNet/PeeringToeastus2",
            "dependsOn": [
                "eastus-VNet",
                "eastus2-VNet"
            ],
            "properties": {
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": false,
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks','eastus2-VNet')]"
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "apiVersion": "2024-07-01",
            "name": "eastus2-VNet/PeeringToeastus",
            "dependsOn": [
                "eastus-VNet",
                "eastus2-VNet"
            ],
            "properties": {
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": false,
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks','eastus-VNet')]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/availabilitySets",
            "apiVersion": "2024-07-01",
            "name": "Web-AvailabilitySet",
            "location": "[parameters('location1')]",
            "sku": {
                "name": "Aligned"
            },
            "properties": {
                "platformFaultDomainCount": 2,
                "platformUpdateDomainCount": 5
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2024-07-01",
            "name": "w1-nic",
            "location": "[parameters('location1')]",
            "dependsOn": [
                "eastus-VNet",
                "Web-LB"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets','eastus-VNet','websubnet')]"
                            },
                            "privateIPAllocationMethod": "Dynamic",
                            "loadBalancerBackendAddressPools": [
                                {
                                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers','Web-LB'), '/backendAddressPools/WebBackendPool')]"
                                }
                            ]
                        }
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups','eastus-Web-NSG')]"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2024-07-01",
            "name": "w2-nic",
            "location": "[parameters('location1')]",
            "dependsOn": [
                "eastus-VNet",
                "Web-LB"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets','eastus-VNet','websubnet')]"
                            },
                            "privateIPAllocationMethod": "Dynamic",
                            "loadBalancerBackendAddressPools": [
                                {
                                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers','Web-LB'), '/backendAddressPools/WebBackendPool')]"
                                }
                            ]
                        }
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups','eastus-Web-NSG')]"
                }
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2024-07-01",
            "name": "RDGateway-pip",
            "location": "[parameters('location1')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 15,
                "dnsSettings": {
                    "domainNameLabel": "[concat('rdgateway-', uniqueString(resourceGroup().id))]"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2024-07-01",
            "name": "RDGateway-nic",
            "location": "[parameters('location1')]",
            "dependsOn": [
                "eastus-VNet",
                "RDGateway-pip"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'eastus-VNet', 'RDGatewaySubnet')]"
                            },
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', 'RDGateway-pip')]"
                            }
                        }
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'eastus-Web-NSG')]"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2024-07-01",
            "name": "WS11-nic",
            "location": "[parameters('location2')]",
            "dependsOn": [
                "eastus2-VNet"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets','eastus2-VNet','appsubnet')]"
                            },
                            "privateIPAllocationMethod": "Dynamic"
                        }
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups','eastus2-WS11-NSG')]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2024-07-01",
            "name": "w1",
            "location": "[parameters('location1')]",
            "dependsOn": [
                "Web-AvailabilitySet",
                "w1-nic"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_B1ms"
                },
                "osProfile": {
                    "computerName": "w1",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]"
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces','w1-nic')]"
                        }
                    ]
                },
                "availabilitySet": {
                    "id": "[resourceId('Microsoft.Compute/availabilitySets','Web-AvailabilitySet')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2019-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "Standard_ZRS"
                        },
                        "diskSizeGB": 128
                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2024-07-01",
            "name": "w2",
            "location": "[parameters('location1')]",
            "dependsOn": [
                "Web-AvailabilitySet",
                "w2-nic"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_B1ms"
                },
                "osProfile": {
                    "computerName": "w2",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]"
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces','w2-nic')]"
                        }
                    ]
                },
                "availabilitySet": {
                    "id": "[resourceId('Microsoft.Compute/availabilitySets','Web-AvailabilitySet')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2019-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "Standard_ZRS"
                        },
                        "diskSizeGB": 128
                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2024-07-01",
            "name": "RDGateway",
            "location": "[parameters('location1')]",
            "dependsOn": [
                "RDGateway-nic"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_B1ms"
                },
                "osProfile": {
                    "computerName": "RDGateway",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]"
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces','RDGateway-nic')]"
                        }
                    ]
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2019-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "Standard_ZRS"
                        },
                        "diskSizeGB": 128
                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2024-07-01",
            "name": "WS11",
            "location": "[parameters('location2')]",
            "dependsOn": [
                "WS11-nic"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_B1ms"
                },
                "osProfile": {
                    "computerName": "WS11",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]"
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces','WS11-nic')]"
                        }
                    ]
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2019-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "Standard_ZRS"
                        },
                        "diskSizeGB": 128
                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2025-03-01",
            "name": "Web-LB-PIP",
            "location": "[parameters('location1')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAllocationMethod": "Static"
            }
        },
        {
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2024-07-01",
            "name": "Web-LB",
            "location": "[parameters('location1')]",
            "dependsOn": [
                "Web-LB-PIP"
            ],
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "LoadBalancerFrontEnd",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses','Web-LB-PIP')]"
                            }
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "WebBackendPool"
                    }
                ],
                "probes": [
                    {
                        "name": "HttpProbe",
                        "properties": {
                            "protocol": "Http",
                            "port": 80,
                            "requestPath": "/",
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        }
                    }
                ],
                "loadBalancingRules": [
                    {
                        "name": "HttpRule",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers','Web-LB'),'/frontendIPConfigurations/LoadBalancerFrontEnd')]"
                            },
                            "backendAddressPool": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers','Web-LB'),'/backendAddressPools/WebBackendPool')]"
                            },
                            "protocol": "Tcp",
                            "frontendPort": 80,
                            "backendPort": 80,
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 4,
                            "probe": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers','Web-LB'),'/probes/HttpProbe')]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2024-07-01",
            "name": "eastus-Web-NSG",
            "location": "[parameters('location1')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "AllowHTTP",
                        "properties": {
                            "priority": 105,
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "80",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowHTTPS",
                        "properties": {
                            "priority": 100,
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "443",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "AllowRDP",
                        "properties": {
                            "priority": 200,
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2024-07-01",
            "name": "eastus2-WS11-NSG",
            "location": "[parameters('location2')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "AllowAdmin",
                        "properties": {
                            "priority": 100,
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "DenyOutboundAll",
                        "properties": {
                            "priority": 4096,
                            "direction": "Outbound",
                            "access": "Deny",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "0.0.0.0/0"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2025-06-01",
            "name": "eastuszrsstorage",
            "location": "[parameters('location1')]",
            "sku": {
                "name": "Standard_ZRS"
            },
            "kind": "StorageV2",
            "properties": {
                "supportsHttpsTrafficOnly": true
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2025-06-01",
            "name": "eastus2grsstorage",
            "location": "[parameters('location2')]",
            "sku": {
                "name": "Standard_GRS"
            },
            "kind": "StorageV2",
            "properties": {
                "supportsHttpsTrafficOnly": true
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
            "apiVersion": "2025-06-01",
            "name": "eastus2grsstorage/default/ws11files",
            "dependsOn": [
                "eastus2grsstorage"
            ],
            "properties": {
                "shareQuota": 100
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2022-04-01",
            "name": "[guid(resourceId('Microsoft.Storage/storageAccounts','eastus2grsstorage'), 'StorageBlobContributor', parameters('adminObjectId'))]",
            "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[parameters('adminObjectId')]",
                "scope": "[resourceGroup().id]"
            }
        },
        {
            "type": "Microsoft.Network/privateEndpoints",
            "apiVersion": "2024-05-01",
            "name": "eastus2grsstorage-pe",
            "location": "[parameters('location2')]",
            "dependsOn": [
                "eastus2grsstorage",
                "eastus2-VNet"
            ],
            "properties": {
                "subnet": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'eastus2-VNet', 'appsubnet')]"
                },
                "privateLinkServiceConnections": [
                    {
                        "name": "StoragePrivateLink",
                        "properties": {
                            "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', 'eastus2grsstorage')]",
                            "groupIds": [
                                "file"
                            ],
                            "requestMessage": "Private endpoint for secure file share WS11Files"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/privateDnsZones",
            "apiVersion": "2020-06-01",
            "name": "privatelink.file.core.windows.net",
            "location": "global"
        },
        {
            "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
            "apiVersion": "2020-06-01",
            "name": "privatelink.file.core.windows.net/eastus2dnslink",
            "location": "global",
            "dependsOn": [
                "privatelink.file.core.windows.net"
            ],
            "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks', 'EastUS2-VNet')]"
                }
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2024-07-01",
            "name": "backend-fw-pip",
            "location": "[parameters('location2')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 15
            }
        },
        {
            "type": "Microsoft.Network/azureFirewalls",
            "apiVersion": "2024-07-01",
            "name": "backend-firewall",
            "location": "[parameters('location2')]",
            "dependsOn": [
                "eastus2-VNet"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "FW-config",
                        "properties": {
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'eastus2-VNet', 'AzureFirewallSubnet')]"
                            },
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', 'backend-fw-pip')]"
                            }
                        }
                    }
                ],
                "applicationRuleCollections": [
                    {
                        "name": "BlockSocialMedia",
                        "properties": {
                            "priority": 100,
                            "action": {
                                "type": "Deny"
                            },
                            "rules": [
                                {
                                    "name": "DenySocialSites",
                                    "description": "Block Facebook, Twitter, Instagram",
                                    "sourceAddresses": [
                                        "10.1.1.0/24"
                                    ],
                                    "protocols": [
                                        {
                                            "protocolType": "Https",
                                            "port": 443
                                        }
                                    ],
                                    "targetFqdns": [
                                        "facebook.com",
                                        "www.facebook.com",
                                        "twitter.com",
                                        "www.twitter.com",
                                        "instagram.com",
                                        "www.instagram.com"
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "sku": {
                    "name": "AZFW_VNet",
                    "tier": "Standard"
                }
            }
        },
        {
            "type": "Microsoft.Network/routeTables",
            "apiVersion": "2024-07-01",
            "name": "backend-rt",
            "location": "[parameters('location2')]",
            "properties": {
                "routes": [
                    {
                        "name": "default-to-firewall",
                        "properties": {
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "[reference(resourceId('Microsoft.Network/azureFirewalls', 'backend-firewall')).ipConfigurations[0].properties.privateIPAddress]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2024-07-01",
            "name": "eastus2-VNet/appsubnet",
            "dependsOn": [
                "eastus2-VNet",
                "backend-rt"
            ],
            "properties": {
                "addressPrefix": "10.1.1.0/24",
                "routeTable": {
                    "id": "[resourceId('Microsoft.Network/routeTables', 'backend-rt')]"
                }
            }
        }
    ],
    "outputs": {
        "eastusStorageAccountName": {
            "type": "String",
            "value": "eastuszrsstorage"
        },
        "eastusStorageAccountKey": {
            "type": "String",
            "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts','eastuszrsstorage'),'2025-06-01').keys[0].value]"
        },
        "eastus2StorageAccountName": {
            "type": "String",
            "value": "eastus2grsstorage"
        },
        "eastus2StorageAccountKey": {
            "type": "String",
            "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts','eastus2grsstorage'),'2025-06-01').keys[0].value]"
        },
        "WS11FileShareURL": {
            "type": "String",
            "value": "[concat('\\\\', 'eastus2grsstorage.file.core.windows.net', '\\WS11Files')]"
        }
    }
}